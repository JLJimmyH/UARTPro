{
  "$meta": {
    "title": "UARTPro â€” Highlight & Filter åŠŸèƒ½é‡æ§‹è¦æ ¼",
    "version": "2.0",
    "date": "2025-02-12",
    "description": "å°‡ whitelist/blacklist åˆä½µç‚º filterï¼Œæ–°å¢ enabled å¯è¦‹æ€§åˆ‡æ›ï¼Œhighlight æ”¯æ´é¡è‰²èª¿æ•´èˆ‡å¤šç¨®é«˜äº®æ¨¡å¼",
    "tech_stack": "Qt 6 / QML + C++ (ConfigManager)",
    "target_files": [
      "main.qml",
      "ConfigManager.h",
      "ConfigManager.cpp"
    ]
  },

  "tasks": [
    {
      "id": "T1",
      "title": "åˆä½µ whitelist/blacklist ç‚ºçµ±ä¸€ Filter æ¨¡å‹",
      "priority": "P0",
      "depends_on": [],
      "description": "å°‡ whitelistModel èˆ‡ blacklistModel åˆä½µç‚ºå–®ä¸€ filterModelï¼Œæ¯é …å¸¶æœ‰ type æ¬„ä½å€åˆ† include/exclude"
    },
    {
      "id": "T2",
      "title": "ç‚ºæ‰€æœ‰ chip åŠ å…¥ enabled å¯è¦‹æ€§åˆ‡æ›ï¼ˆçœ¼ç› iconï¼‰",
      "priority": "P0",
      "depends_on": ["T1"]
    },
    {
      "id": "T3",
      "title": "Highlight æ”¯æ´é¡è‰²èª¿æ•´ï¼ˆè‰²ç›¤ popupï¼‰",
      "priority": "P1",
      "depends_on": ["T2"]
    },
    {
      "id": "T4",
      "title": "Highlight æ”¯æ´å¤šç¨®é«˜äº®æ¨¡å¼ (bg / text / line)",
      "priority": "P1",
      "depends_on": ["T2"]
    },
    {
      "id": "T5",
      "title": "æ›´æ–° ConfigManager C++ å¾Œç«¯",
      "priority": "P0",
      "depends_on": ["T1"]
    },
    {
      "id": "T6",
      "title": "æ›´æ–°å³éµé¸å–®",
      "priority": "P1",
      "depends_on": ["T1"]
    }
  ],

  "data_model": {
    "before": {
      "description": "ç›®å‰çš„è³‡æ–™çµæ§‹",
      "keywordModel_item": {
        "text": "string â€” é—œéµå­—æ–‡å­—",
        "color": "string â€” hex é¡è‰²ç¢¼ï¼Œå¦‚ #00ff88"
      },
      "whitelistModel_item": {
        "text": "string"
      },
      "blacklistModel_item": {
        "text": "string"
      },
      "qml_models": [
        "ListModel { id: keywordModel }",
        "ListModel { id: whitelistModel }",
        "ListModel { id: blacklistModel }"
      ]
    },

    "after": {
      "description": "é‡æ§‹å¾Œçš„è³‡æ–™çµæ§‹",

      "keywordModel_item": {
        "text": "string â€” é—œéµå­—æ–‡å­—",
        "color": "string â€” hex é¡è‰²ç¢¼ï¼Œå¦‚ #00ff88",
        "enabled": "bool â€” æ˜¯å¦å•Ÿç”¨ï¼Œé è¨­ true",
        "mode": "string â€” é«˜äº®æ¨¡å¼ï¼Œå¯é¸å€¼: 'bg' | 'text' | 'line'ï¼Œé è¨­ 'bg'"
      },

      "filterModel_item": {
        "text": "string â€” éæ¿¾é—œéµå­—",
        "filterType": "string â€” éæ¿¾é¡å‹ï¼Œå¯é¸å€¼: 'include' | 'exclude'",
        "enabled": "bool â€” æ˜¯å¦å•Ÿç”¨ï¼Œé è¨­ true"
      },

      "qml_models": [
        "ListModel { id: keywordModel;  onCountChanged: { syncKeywordsToConfig() } }",
        "ListModel { id: filterModel;   onCountChanged: { rebuildFilteredModel(); syncFiltersToConfig() } }"
      ],

      "note": "ç§»é™¤ whitelistModel å’Œ blacklistModelï¼Œçµ±ä¸€ç‚º filterModel"
    }
  },

  "json_config": {
    "before": {
      "file": "uartpro_config.json",
      "schema": {
        "version": 1,
        "keywords": [
          { "text": "voltage", "color": "#00ff88" }
        ],
        "whitelist": [
          { "text": "sensor" }
        ],
        "blacklist": [
          { "text": "noise" }
        ]
      }
    },

    "after": {
      "file": "uartpro_config.json",
      "version_bump": "å°‡ CONFIG_VERSION å¾ 1 å‡ç‚º 2",
      "schema": {
        "version": 2,
        "keywords": [
          { "text": "voltage", "color": "#00ff88", "enabled": true, "mode": "bg" },
          { "text": "error",   "color": "#ff3366", "enabled": true, "mode": "line" },
          { "text": "OK",      "color": "#00d4ff", "enabled": false, "mode": "text" }
        ],
        "filters": [
          { "text": "sensor", "filterType": "include", "enabled": true },
          { "text": "motor",  "filterType": "include", "enabled": true },
          { "text": "debug",  "filterType": "exclude", "enabled": true },
          { "text": "noise",  "filterType": "exclude", "enabled": false }
        ]
      },

      "migration": {
        "description": "è®€å– v1 é…ç½®æ™‚è‡ªå‹•é·ç§»",
        "rules": [
          "è‹¥ JSON ç„¡ version æ¬„ä½æˆ– version === 1ï¼ŒåŸ·è¡Œé·ç§»",
          "whitelist[] â†’ filters[]ï¼Œæ¯é …åŠ  filterType: 'include', enabled: true",
          "blacklist[] â†’ filters[]ï¼Œæ¯é …åŠ  filterType: 'exclude', enabled: true",
          "keywords[] æ¯é …åŠ  enabled: true, mode: 'bg'ï¼ˆè‹¥ç¼ºå¤±ï¼‰",
          "é·ç§»å¾Œå¯«å›æ™‚ä½¿ç”¨ version: 2ï¼Œä¸å†å¯«å‡º whitelist/blacklist æ¬„ä½"
        ]
      }
    }
  },

  "cpp_backend_changes": {
    "file_header": "ConfigManager.h",
    "file_impl": "ConfigManager.cpp",

    "remove": {
      "members": ["QVariantList m_whitelist", "QVariantList m_blacklist"],
      "methods": [
        "QVariantList whitelist() const",
        "void setWhitelist(const QVariantList &list)",
        "QVariantList blacklist() const",
        "void setBlacklist(const QVariantList &list)"
      ]
    },

    "add": {
      "members": ["QVariantList m_filters"],
      "methods": [
        {
          "signature": "Q_INVOKABLE QVariantList filters() const",
          "returns": "m_filters"
        },
        {
          "signature": "Q_INVOKABLE void setFilters(const QVariantList &list)",
          "body": "m_filters = list; scheduleSave();"
        }
      ]
    },

    "readArray_changes": {
      "description": "ä¿®æ”¹ loadInternal() ä¸­çš„ readArray lambdaï¼Œæ”¯æ´æ–°æ¬„ä½",
      "keywords_read": {
        "fields_to_read": ["text", "color", "enabled (default: true)", "mode (default: 'bg')"],
        "code_hint": "item['enabled'] = obj.contains('enabled') ? obj['enabled'].toBool() : true; item['mode'] = obj.contains('mode') ? obj['mode'].toString() : 'bg';"
      },
      "filters_read": {
        "fields_to_read": ["text", "filterType", "enabled (default: true)"],
        "code_hint": "item['filterType'] = obj['filterType'].toString(); item['enabled'] = obj.contains('enabled') ? obj['enabled'].toBool() : true;"
      },
      "migration_logic": {
        "description": "åœ¨ loadInternal() ä¸­åˆ¤æ–· version æ¬„ä½",
        "pseudocode": [
          "int ver = root['version'].toInt(1);",
          "if (ver < 2) {",
          "  // è®€å–èˆŠæ ¼å¼ whitelist â†’ filters (include)",
          "  // è®€å–èˆŠæ ¼å¼ blacklist â†’ filters (exclude)",
          "  // keywords è£œä¸Š enabled=true, mode='bg'",
          "}",
          "else {",
          "  // è®€å–æ–°æ ¼å¼ filters",
          "}"
        ]
      }
    },

    "writeArray_changes": {
      "description": "ä¿®æ”¹ saveToFile()ï¼Œåªå¯«å‡ºæ–°æ ¼å¼",
      "keywords_write": {
        "fields_to_write": ["text", "color", "enabled", "mode"]
      },
      "filters_write": {
        "fields_to_write": ["text", "filterType", "enabled"]
      },
      "output_keys": {
        "remove": ["whitelist", "blacklist"],
        "add": ["filters"],
        "keep": ["keywords"]
      }
    }
  },

  "qml_ui_changes": {

    "toolbar_layout": {
      "file": "main.qml",
      "location": "filterToolbarCol (ç´„ line 1550-1740)",
      "description": "é‡æ§‹ filter toolbar è¼¸å…¥åˆ—èˆ‡ chips å€åŸŸ",

      "combo_box": {
        "before": {
          "id": "filterTypeCombo",
          "model": ["Highlight", "Whitelist", "Blacklist"],
          "location": "line 1565-1577"
        },
        "after": {
          "id": "filterTypeCombo",
          "model": ["Highlight", "Filter"],
          "behavior": "é¸ Highlight æ™‚é€²å…¥é«˜äº®æ¨¡å¼ï¼›é¸ Filter æ™‚é€²å…¥éæ¿¾æ¨¡å¼"
        }
      },

      "filter_subtype_combo": {
        "description": "æ–°å¢ç¬¬äºŒå€‹ ComboBoxï¼Œåªåœ¨ filterTypeCombo === 1 (Filter) æ™‚é¡¯ç¤º",
        "id": "filterSubTypeCombo",
        "model": ["Include", "Exclude"],
        "default_index": 0,
        "accent_colors": {
          "include": "root.colorAccent (ç¶ è‰²ç³»)",
          "exclude": "root.colorDestructive (ç´…è‰²ç³»)"
        },
        "visibility": "visible: filterTypeCombo.currentIndex === 1",
        "preferred_width": 100
      },

      "text_input": {
        "id": "filterInput",
        "placeholder_logic": {
          "highlight": "'highlight keyword...'",
          "filter_include": "'include filter...'",
          "filter_exclude": "'exclude filter...'"
        },
        "accent_color_logic": "ä¾æ“šç›®å‰é¸æ“‡çš„é¡å‹å‹•æ…‹è®ŠåŒ–"
      },

      "add_button": {
        "description": "'+' æŒ‰éˆ•çš„ onClicked é‚è¼¯æ›´æ–°",
        "logic": "å‘¼å« addFilterFromInput()ï¼Œæ ¹æ“š combo ç‹€æ…‹åˆ†æµåˆ° addKeyword() æˆ– addFilter()"
      }
    },

    "chips_area": {
      "location": "Flow layout (ç´„ line 1609-1738)",
      "description": "é‡æ§‹ chips é¡¯ç¤ºå€åŸŸ",

      "keyword_chips": {
        "description": "Highlight é—œéµå­— chips â€” åŠ å…¥è‰²å¡Šã€æ¨¡å¼æŒ‡ç¤ºã€çœ¼ç› icon",
        "chip_layout": {
          "structure": "[è‰²å¡Š] [modeæ¨™ç±¤] text [çœ¼ç›icon] [Ã—]",
          "total_height": 24,
          "components": [
            {
              "name": "colorSwatch",
              "type": "Rectangle",
              "size": "12x12",
              "radius": 2,
              "color": "model.color",
              "behavior": "é»æ“Šå½ˆå‡º colorPickerPopup",
              "cursor": "Qt.PointingHandCursor"
            },
            {
              "name": "modeLabel",
              "type": "Text",
              "display": {
                "bg": "BG",
                "text": "TX",
                "line": "LN"
              },
              "font_size": 8,
              "font_bold": true,
              "color": "model.color",
              "opacity": 0.7,
              "behavior": "é»æ“Šå¾ªç’°åˆ‡æ›æ¨¡å¼: bg â†’ text â†’ line â†’ bg",
              "cursor": "Qt.PointingHandCursor"
            },
            {
              "name": "keywordText",
              "type": "Text",
              "text": "model.text",
              "font_size": 10,
              "color": "model.color"
            },
            {
              "name": "visibilityToggle",
              "type": "Text",
              "text_when_enabled": "\uD83D\uDC41",
              "fallback_unicode": "ğŸ‘ (æˆ–ä½¿ç”¨ \\u25C9 â—‰ å•Ÿç”¨ / \\u25CB â—‹ åœç”¨ï¼Œè¦–å­—é«”æ”¯æ´åº¦)",
              "recommended": "ä½¿ç”¨å…©å€‹ç´”æ–‡å­—ç¬¦è™Ÿ: enabled â†’ 'â—‰' (\\u25C9), disabled â†’ 'â—‹' (\\u25CB)",
              "font_size": 10,
              "opacity_when_enabled": 0.8,
              "opacity_when_disabled": 0.3,
              "behavior": "é»æ“Šåˆ‡æ› model.enabledï¼Œè§¸ç™¼ keywordRevision++ èˆ‡ syncKeywordsToConfig()",
              "cursor": "Qt.PointingHandCursor"
            },
            {
              "name": "deleteButton",
              "type": "Text",
              "text": "âœ• (\\u2715)",
              "behavior": "èˆ‡ç¾æœ‰ç›¸åŒï¼Œç§»é™¤é …ç›®"
            }
          ],
          "chip_background": {
            "when_enabled": "Qt.rgba(color.r, color.g, color.b, 0.15)",
            "when_disabled": "Qt.rgba(color.r, color.g, color.b, 0.05)",
            "border_when_enabled": "model.color",
            "border_when_disabled": "Qt.rgba(color.r, color.g, color.b, 0.3)"
          }
        }
      },

      "filter_chips": {
        "description": "Filter chips â€” å–ä»£èˆŠçš„ whitelist/blacklist chips",
        "note": "åªæœ‰ä¸€å€‹ Repeaterï¼Œmodel ç‚º filterModel",
        "chip_layout": {
          "structure": "[prefix] text [çœ¼ç›icon] [Ã—]",
          "total_height": 22,
          "components": [
            {
              "name": "prefixAndText",
              "type": "Text",
              "text_logic": "(model.filterType === 'include' ? '+' : 'âˆ’') + ' ' + model.text",
              "font_size": 10,
              "color_logic": {
                "include": "root.colorAccent",
                "exclude": "root.colorDestructive"
              }
            },
            {
              "name": "visibilityToggle",
              "type": "Text",
              "recommended": "enabled â†’ 'â—‰' (\\u25C9), disabled â†’ 'â—‹' (\\u25CB)",
              "font_size": 10,
              "opacity_when_enabled": 0.8,
              "opacity_when_disabled": 0.3,
              "behavior": "é»æ“Šåˆ‡æ› model.enabledï¼Œè§¸ç™¼ rebuildFilteredModel() èˆ‡ syncFiltersToConfig()",
              "cursor": "Qt.PointingHandCursor"
            },
            {
              "name": "deleteButton",
              "type": "Text",
              "text": "âœ• (\\u2715)",
              "behavior": "filterModel.remove(index); syncFiltersToConfig()"
            }
          ],
          "chip_background": {
            "include_enabled": "Qt.rgba(colorAccent.r, colorAccent.g, colorAccent.b, 0.15)",
            "include_disabled": "Qt.rgba(colorAccent.r, colorAccent.g, colorAccent.b, 0.05)",
            "exclude_enabled": "Qt.rgba(colorDestructive.r, colorDestructive.g, colorDestructive.b, 0.15)",
            "exclude_disabled": "Qt.rgba(colorDestructive.r, colorDestructive.g, colorDestructive.b, 0.05)",
            "border_color": "åŒ chip text colorï¼Œdisabled æ™‚ opacity é™è‡³ 0.3"
          }
        }
      }
    },

    "color_picker_popup": {
      "description": "æ–°å¢è‰²ç›¤å½ˆå‡ºå…ƒä»¶ï¼Œä¾› keyword chip çš„è‰²å¡Šé»æ“Šæ™‚ä½¿ç”¨",
      "id": "colorPickerPopup",
      "type": "Popup",
      "properties": {
        "width": 180,
        "height": 80,
        "modal": false,
        "closePolicy": "Popup.CloseOnPressOutside | Popup.CloseOnEscape"
      },
      "state": {
        "property_targetIndex": "int â€” ç›®å‰ç·¨è¼¯çš„ keywordModel index",
        "open_function": "function openColorPicker(chipIndex, chipX, chipY) { targetIndex = chipIndex; x = chipX; y = chipY + 26; open() }"
      },
      "content": {
        "layout": "Grid or Flow",
        "palette_colors": ["#ff3366", "#ffaa00", "#00ff88", "#00d4ff", "#ff00ff", "#ffff00", "#ff6600", "#aa66ff"],
        "each_swatch": {
          "type": "Rectangle",
          "size": "20x20",
          "radius": 3,
          "border": "ç›®å‰è¢«é¸ä¸­çš„è‰²é¡¯ç¤ºç™½è‰²é‚Šæ¡† 2pxï¼Œå…¶é¤˜ç„¡é‚Šæ¡†",
          "on_click": {
            "steps": [
              "keywordModel.setProperty(targetIndex, 'color', selectedColor)",
              "root.keywordRevision++",
              "syncKeywordsToConfig()",
              "colorPickerPopup.close()"
            ]
          }
        },
        "custom_hex_input": {
          "description": "å¯é¸ï¼šåº•éƒ¨åŠ ä¸€å€‹å°å‹ TextField è®“ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥ hex è‰²ç¢¼",
          "priority": "nice-to-haveï¼Œå¯å…ˆä¸åš",
          "validation": "ä»¥ /^#[0-9a-fA-F]{6}$/ é©—è­‰"
        }
      }
    },

    "toggle_all_button": {
      "description": "å¯é¸åŠŸèƒ½ â€” åœ¨ chips å€åŸŸåŠ å…¥å…¨éƒ¨å•Ÿç”¨/åœç”¨çš„å¿«æ·æŒ‰éˆ•",
      "priority": "nice-to-have",
      "implementation": {
        "highlight_toggle": {
          "text": "'â—‰' æˆ– 'â—‹' ä¾æ“šæ˜¯å¦å…¨éƒ¨å•Ÿç”¨",
          "position": "åœ¨ keyword chips å‰æ–¹æˆ– Flow çš„ç¬¬ä¸€å€‹å…ƒç´ ",
          "on_click": "éæ­· keywordModel å…¨éƒ¨è¨­ enabled = !allEnabled; keywordRevision++; syncKeywordsToConfig()"
        },
        "filter_toggle": {
          "text": "'â—‰' æˆ– 'â—‹' ä¾æ“šæ˜¯å¦å…¨éƒ¨å•Ÿç”¨",
          "position": "åœ¨ filter chips å‰æ–¹",
          "on_click": "éæ­· filterModel å…¨éƒ¨è¨­ enabled = !allEnabled; rebuildFilteredModel(); syncFiltersToConfig()"
        }
      }
    }
  },

  "function_changes": {

    "addFilterFromInput": {
      "location": "main.qml ~line 2913",
      "before": "æ ¹æ“š filterTypeCombo.currentIndex åˆ†æµåˆ° addKeyword / addWhitelist / addBlacklist",
      "after": {
        "logic": [
          "var text = filterInput.text.trim()",
          "if (text === '') return",
          "if (filterTypeCombo.currentIndex === 0) {",
          "    addKeyword(text)",
          "} else {",
          "    var type = filterSubTypeCombo.currentIndex === 0 ? 'include' : 'exclude'",
          "    addFilter(text, type)",
          "}",
          "filterInput.text = ''"
        ]
      }
    },

    "addKeyword": {
      "location": "main.qml ~line 2925",
      "before": "keywordModel.append({ text: text, color: color })",
      "after": {
        "logic": [
          "var color = root.kwPalette[root.kwColorIndex % root.kwPalette.length]",
          "root.kwColorIndex++",
          "keywordModel.append({ text: text, color: color, enabled: true, mode: 'bg' })",
          "root.keywordRevision++",
          "syncKeywordsToConfig()"
        ]
      }
    },

    "addFilter": {
      "description": "æ–°å‡½å¼ï¼Œå–ä»£èˆŠçš„ addWhitelist / addBlacklist",
      "signature": "function addFilter(text, filterType)",
      "logic": [
        "text = text.trim()",
        "if (text === '') return",
        "filterModel.append({ text: text, filterType: filterType, enabled: true })",
        "syncFiltersToConfig()"
      ]
    },

    "remove_functions": [
      "addWhitelist(text) â€” ç”± addFilter(text, 'include') å–ä»£",
      "addBlacklist(text) â€” ç”± addFilter(text, 'exclude') å–ä»£",
      "syncWhitelistToConfig() â€” ç”± syncFiltersToConfig() å–ä»£",
      "syncBlacklistToConfig() â€” ç”± syncFiltersToConfig() å–ä»£"
    ],

    "syncKeywordsToConfig": {
      "location": "main.qml ~line 2950",
      "before": "åªæ¨é€ { text, color }",
      "after": {
        "logic": [
          "var list = []",
          "for (var i = 0; i < keywordModel.count; i++) {",
          "    var item = keywordModel.get(i)",
          "    list.push({ text: item.text, color: item.color, enabled: item.enabled, mode: item.mode })",
          "}",
          "configManager.setKeywords(list)"
        ]
      }
    },

    "syncFiltersToConfig": {
      "description": "æ–°å‡½å¼ï¼Œå–ä»£èˆŠçš„ syncWhitelistToConfig + syncBlacklistToConfig",
      "logic": [
        "var list = []",
        "for (var i = 0; i < filterModel.count; i++) {",
        "    var item = filterModel.get(i)",
        "    list.push({ text: item.text, filterType: item.filterType, enabled: item.enabled })",
        "}",
        "configManager.setFilters(list)"
      ]
    },

    "passesFilter": {
      "location": "main.qml ~line 2609",
      "before": "åˆ†åˆ¥éæ­· whitelistModel å’Œ blacklistModel",
      "after": {
        "logic": [
          "function passesFilter(entry) {",
          "    if (entry.type === 'system' || entry.type === 'error') return true",
          "    var text = entry.msgText.toLowerCase()",
          "",
          "    // æ”¶é›†å•Ÿç”¨çš„ include å’Œ exclude é …ç›®",
          "    var includes = []",
          "    var excludes = []",
          "    for (var i = 0; i < filterModel.count; i++) {",
          "        var f = filterModel.get(i)",
          "        if (!f.enabled) continue",
          "        if (f.filterType === 'include') includes.push(f.text.toLowerCase())",
          "        else excludes.push(f.text.toLowerCase())",
          "    }",
          "",
          "    // Include é‚è¼¯: è‹¥æœ‰ä»»ä½• include é …ï¼Œå¿…é ˆåŒ¹é…è‡³å°‘ä¸€å€‹ (OR)",
          "    if (includes.length > 0) {",
          "        var pass = false",
          "        for (var j = 0; j < includes.length; j++) {",
          "            if (text.indexOf(includes[j]) >= 0) { pass = true; break }",
          "        }",
          "        if (!pass) return false",
          "    }",
          "",
          "    // Exclude é‚è¼¯: ä¸å¾—åŒ…å«ä»»ä½• exclude é … (AND NOT)",
          "    for (var k = 0; k < excludes.length; k++) {",
          "        if (text.indexOf(excludes[k]) >= 0) return false",
          "    }",
          "",
          "    return true",
          "}"
        ]
      }
    },

    "highlightText": {
      "location": "main.qml ~line 2709",
      "before": "æ‰€æœ‰é—œéµå­—éƒ½ç”¨èƒŒæ™¯è‰²é«˜äº®",
      "after": {
        "description": "æ ¹æ“š mode å’Œ enabled åˆ†åˆ¥è™•ç†ï¼Œline æ¨¡å¼ä¸åœ¨æ­¤å‡½å¼è™•ç†",
        "logic": [
          "function highlightText(raw) {",
          "    var html = escapeHtml(raw)",
          "",
          "    for (var i = 0; i < keywordModel.count; i++) {",
          "        var kw = keywordModel.get(i)",
          "        if (!kw.enabled) continue",
          "        if (kw.mode === 'line') continue  // line æ¨¡å¼åœ¨ delegate å±¤è™•ç†",
          "",
          "        var escaped = escapeRegex(escapeHtml(kw.text))",
          "        var re = new RegExp('(' + escaped + ')', 'gi')",
          "",
          "        if (kw.mode === 'bg') {",
          "            // èƒŒæ™¯é«˜äº®ï¼ˆåŸæœ‰è¡Œç‚ºï¼‰",
          "            html = html.replace(re,",
          "                \"<span style='background-color:\" + kw.color + \";color:\" + root.colorBg + \";font-weight:bold;'>$1</span>\")",
          "        } else if (kw.mode === 'text') {",
          "            // ç´”æ–‡å­—é¡è‰²",
          "            html = html.replace(re,",
          "                \"<span style='color:\" + kw.color + \";font-weight:bold;'>$1</span>\")",
          "        }",
          "    }",
          "",
          "    // æ•¸å­—è‘—è‰²ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰",
          "    if (root.colorNumbers) {",
          "        var numColor = String(root.colorAccentTertiary)",
          "        html = html.replace(/(<[^>]+>)|(\\b(?:0x[0-9a-fA-F]+|\\d+\\.?\\d*)\\b)/g, function(match, tag, num) {",
          "            if (tag) return tag",
          "            return \"<span style='color:\" + numColor + \";'>\" + num + \"</span>\"",
          "        })",
          "    }",
          "",
          "    return html",
          "}"
        ]
      }
    },

    "getLineHighlightColor": {
      "description": "æ–°å¢è¼”åŠ©å‡½å¼ â€” ä¾› delegate åˆ¤æ–·æ˜¯å¦éœ€è¦æ•´è¡ŒèƒŒæ™¯è‰²",
      "logic": [
        "function getLineHighlightColor(msgText) {",
        "    // å›å‚³ç¬¬ä¸€å€‹åŒ¹é…çš„ line-mode é—œéµå­—çš„é¡è‰²ï¼Œç„¡åŒ¹é…å›å‚³ 'transparent'",
        "    var text = msgText.toLowerCase()",
        "    for (var i = 0; i < keywordModel.count; i++) {",
        "        var kw = keywordModel.get(i)",
        "        if (!kw.enabled || kw.mode !== 'line') continue",
        "        if (text.indexOf(kw.text.toLowerCase()) >= 0)",
        "            return kw.color",
        "    }",
        "    return 'transparent'",
        "}"
      ]
    },

    "loadConfigToUI": {
      "location": "main.qml ~line 2973",
      "before": "åˆ†åˆ¥è¼‰å…¥ keywordModel, whitelistModel, blacklistModel",
      "after": {
        "logic": [
          "function loadConfigToUI() {",
          "    root.uiScale = configManager.uiScale",
          "    root.terminalFontSize = configManager.terminalFontSize",
          "    root.applyTheme(configManager.currentTheme)",
          "    root.showPrefix = configManager.showPrefix",
          "",
          "    // Keywords",
          "    keywordModel.clear()",
          "    var kws = configManager.keywords()",
          "    for (var i = 0; i < kws.length; i++) {",
          "        keywordModel.append({",
          "            text: kws[i].text,",
          "            color: kws[i].color,",
          "            enabled: kws[i].enabled !== undefined ? kws[i].enabled : true,",
          "            mode: kws[i].mode || 'bg'",
          "        })",
          "    }",
          "    root.kwColorIndex = kws.length",
          "    root.keywordRevision++",
          "",
          "    // Filters",
          "    filterModel.clear()",
          "    var filters = configManager.filters()",
          "    for (var j = 0; j < filters.length; j++) {",
          "        filterModel.append({",
          "            text: filters[j].text,",
          "            filterType: filters[j].filterType || 'include',",
          "            enabled: filters[j].enabled !== undefined ? filters[j].enabled : true",
          "        })",
          "    }",
          "}"
        ]
      }
    }
  },

  "delegate_changes": {
    "location": "main.qml ~line 1807-1987 (entryDelegate)",
    "description": "åœ¨ entry delegate ä¸­åŠ å…¥ line æ¨¡å¼çš„æ•´è¡ŒèƒŒæ™¯è‰²",

    "add_line_highlight_rect": {
      "description": "åœ¨ç¾æœ‰çš„ selection highlight å’Œ search highlight ä¹‹é–“ï¼Œæ–°å¢ line-mode é«˜äº®èƒŒæ™¯",
      "insert_after": "line 1853 (selection highlight Rectangle çµæŸä¹‹å¾Œ)",
      "code": [
        "// Line-mode keyword highlight background",
        "Rectangle {",
        "    anchors.fill: parent",
        "    color: {",
        "        root.keywordRevision  // è¿½è¹¤é—œéµå­—è®Šå‹•",
        "        var c = getLineHighlightColor(String(entryDelegate.msgText))",
        "        if (c === 'transparent') return 'transparent'",
        "        var qc = Qt.color(c)",
        "        return Qt.rgba(qc.r, qc.g, qc.b, 0.18)",
        "    }",
        "}"
      ],
      "note": "æ”¾åœ¨ search highlight ä¹‹å‰ï¼Œé€™æ¨£ search highlight æœƒç–ŠåŠ åœ¨ä¸Šé¢ä¸è¢«é®æ“‹"
    }
  },

  "context_menu_changes": {
    "location": "main.qml ~line 478-519 (terminalContextMenu)",
    "description": "æ›´æ–°å³éµé¸å–®é …ç›®",

    "before": [
      { "text": "+ HIGHLIGHT THIS", "action": "addKeyword(root.lastClickedRowText)" },
      { "text": "+ ADD TO WHITELIST", "action": "addWhitelist(root.lastClickedRowText)" },
      { "text": "âˆ’ ADD TO BLACKLIST", "action": "addBlacklist(root.lastClickedRowText)" }
    ],

    "after": [
      {
        "text": "+ HIGHLIGHT THIS",
        "color": "#ffaa00",
        "action": "addKeyword(root.lastClickedRowText)",
        "note": "ä¿æŒä¸è®Š"
      },
      {
        "text": "+ INCLUDE IN FILTER",
        "color": "root.colorAccent",
        "action": "addFilter(root.lastClickedRowText, 'include')"
      },
      {
        "text": "âˆ’ EXCLUDE FROM FILTER",
        "color": "root.colorDestructive",
        "action": "addFilter(root.lastClickedRowText, 'exclude')"
      }
    ]
  },

  "rebuildFilteredModel_trigger": {
    "description": "rebuildFilteredModel çš„è§¸ç™¼æ™‚æ©Ÿæ›´æ–°",
    "before": "whitelistModel.onCountChanged å’Œ blacklistModel.onCountChanged",
    "after": {
      "triggers": [
        "filterModel.onCountChanged â€” é …ç›®å¢æ¸›æ™‚",
        "æ‰‹å‹•å‘¼å« â€” ç•¶ filter chip çš„ enabled è¢«åˆ‡æ›æ™‚ï¼ˆå› ç‚º onCountChanged ä¸æœƒè§¸ç™¼ï¼‰"
      ],
      "note": "åˆ‡æ› enabled æ™‚å¿…é ˆæ‰‹å‹•å‘¼å« rebuildFilteredModel()ï¼Œå› ç‚º ListModel çš„ setProperty ä¸è§¸ç™¼ onCountChanged"
    }
  },

  "implementation_order": [
    {
      "step": 1,
      "description": "ä¿®æ”¹ ConfigManager (C++)",
      "details": [
        "ç§»é™¤ whitelist/blacklist æˆå“¡èˆ‡æ–¹æ³•",
        "æ–°å¢ filters æˆå“¡èˆ‡æ–¹æ³•",
        "æ›´æ–° readArray/writeArray æ”¯æ´æ–°æ¬„ä½",
        "åŠ å…¥ v1 â†’ v2 é·ç§»é‚è¼¯"
      ]
    },
    {
      "step": 2,
      "description": "æ›´æ–° QML è³‡æ–™æ¨¡å‹",
      "details": [
        "ç§»é™¤ whitelistModelã€blacklistModel",
        "æ–°å¢ filterModel",
        "æ›´æ–° keywordModel é …ç›®çµæ§‹åŠ å…¥ enabled, mode"
      ]
    },
    {
      "step": 3,
      "description": "æ›´æ–° JS å‡½å¼",
      "details": [
        "ä¿®æ”¹ addFilterFromInput, passesFilter, highlightText",
        "æ–°å¢ addFilter, syncFiltersToConfig, getLineHighlightColor",
        "ç§»é™¤ addWhitelist, addBlacklist, syncWhitelistToConfig, syncBlacklistToConfig",
        "æ›´æ–° loadConfigToUI, syncKeywordsToConfig"
      ]
    },
    {
      "step": 4,
      "description": "é‡æ§‹ toolbar UI",
      "details": [
        "ComboBox æ”¹ç‚º ['Highlight', 'Filter']",
        "æ–°å¢ filterSubTypeCombo (Include/Exclude)",
        "é‡æ–°å»ºæ§‹ chips å€åŸŸ",
        "åŠ å…¥çœ¼ç› icon å¯è¦‹æ€§åˆ‡æ›",
        "åŠ å…¥è‰²å¡Šé»æ“Šèˆ‡æ¨¡å¼åˆ‡æ›"
      ]
    },
    {
      "step": 5,
      "description": "æ–°å¢ colorPickerPopup",
      "details": [
        "8 è‰²è‰²ç›¤ Grid",
        "é»æ“Šåˆ‡æ›é¡è‰²",
        "å¯é¸: è‡ªè¨‚ hex è¼¸å…¥"
      ]
    },
    {
      "step": 6,
      "description": "æ›´æ–° delegate èˆ‡å³éµé¸å–®",
      "details": [
        "delegate åŠ å…¥ line-mode èƒŒæ™¯ Rectangle",
        "å³éµé¸å–®æ–‡å­—æ›´æ–°ç‚º Include/Exclude"
      ]
    },
    {
      "step": 7,
      "description": "æ¸¬è©¦èˆ‡é©—è­‰",
      "details": [
        "ç¢ºèª v1 config é·ç§»æ­£ç¢º",
        "ç¢ºèª highlight ä¸‰ç¨®æ¨¡å¼éƒ½æ­£å¸¸é‹ä½œ",
        "ç¢ºèª filter include/exclude é‚è¼¯æ­£ç¢º",
        "ç¢ºèª enabled åˆ‡æ›å³æ™‚ç”Ÿæ•ˆ",
        "ç¢ºèªé¡è‰²è®Šæ›´å³æ™‚åæ˜ åœ¨çµ‚ç«¯"
      ]
    }
  ]
}
